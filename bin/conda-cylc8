#!/usr/bin/env bash

# shellcheck disable=SC1090
. "${HOME}/mambaforge/etc/profile.d/conda.sh"

if [[ $# -eq 0 || $# -gt 2 ]]; then
    echo 'usage: c8 ENV_NAME PY_VERSION'
    echo
    echo 'c8: (re)create a conda environment for developing cylc.'
    exit
fi

# NOTE: doesn't use set -eu because conda doesn't like it

NAME="$1"
PY_VERSION="${2:-3.7}"

# (re)create and activate the environment
conda create -n "${NAME}"
conda activate "${NAME}"

CONDA=(
    python="$PY_VERSION"
    #Â pyzmq==19.0.*
    'pyuv>=1.4.0,<1.5.0'
    nodejs
    configurable-http-proxy
    graphviz
    pygraphviz
    yarn
)

echo '# installing conda packages'
# shellcheck disable=SC2068
mamba install ${CONDA[@]}

# cylc-xtriggers
PIP_REPOS=(
    isodatetime
    rose
    cylc-flow
    cylc-sphinx-extensions
    cylc-doc
    jupyter_server
    cylc-uiserver
    cylc-rose
)

PIP=(
    black
    pipdeptree
    remote_pdb
    memory-profiler
)

echo '# installing pip packages'
for module in "${PIP_REPOS[@]}"; do
    module_dir="${HOME}/${module}"
    if [[ -d "${module_dir}" ]]; then
        (cd "${module_dir}"; pip install -e '.[all]')
    fi
done
pip install "${PIP[@]}"

YARN=(\
    cylc-ui
)

echo '# installing node packages'
for module in "${YARN[@]}"; do
    module_dir="${HOME}/${module}"
    if [[ -d "${module_dir}" ]]; then
        (cd "${HOME}/${module}"; yarn install)
    fi
done
