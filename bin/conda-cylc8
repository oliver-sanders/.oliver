#!/usr/bin/env bash

# shellcheck disable=SC1090
. "${HOME}/miniconda3/etc/profile.d/conda.sh"

if [[ $# -ne 1 ]]; then
    echo 'usage: c8 ENV_NAME'
    echo
    echo 'c8: (re)create a conda environment for developing cylc.'
    exit
fi

# NOTE: doesn't use set -eu because conda doesn't like it

NAME="$1"

# use the conda-forge channels
conda config --add channels conda-forge
conda config --set channel_priority strict 

# (re)create and activate the environment
conda create -n "${NAME}"
conda activate "${NAME}"

CONDA=(\
    python==3.7
    pyzmq==18.0.*
    nodejs
    configurable-http-proxy
    pygraphviz
    yarn
)

echo '# installing conda packages'
# shellcheck disable=SC2068
conda install ${CONDA[@]}

PIP=(\
    isodatetime
    cylc-flow
    cylc-sphinx-extensions
    cylc-doc
    cylc-xtriggers
    cylc-uiserver
)

echo '# installing pip packages'
for module in "${PIP[@]}"; do
    module_dir="${HOME}/${module}"
    if [[ -d "${module_dir}" ]]; then
        (cd "${module_dir}"; pip install -e '.[all]')
    fi
done

NODE=(\
    cylc-ui
)

echo '# installing node packages'
for module in "${NODE[@]}"; do
    module_dir="${HOME}/${module}"
    if [[ -d "${module_dir}" ]]; then
        (cd "${HOME}/${module}"; yarn install)
    fi
done
